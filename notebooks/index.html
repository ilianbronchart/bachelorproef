<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Image Carousel (One Label, Multiple Points)</title>
    <style>
    #carouselContainer {
      position: relative;
      width: 600px; /* Adjust to your desired width */
      margin: 20px auto;
    }

    #imageCanvas {
      border: 1px solid #ccc;
      display: block;
    }

    #navButtons {
      text-align: center;
      margin-top: 10px;
    }
    </style>
  </head>
  <body>
    <div id="carouselContainer">
      <canvas id="imageCanvas" width="600" height="400"></canvas>
    </div>
    <div id="navButtons">
      <button onclick="prevImage()">Previous</button>
      <button onclick="nextImage()">Next</button>
      <button onclick="exportJSON()">Export to JSON</button>
      <button onclick="setLabelForCurrentImage()">Set Label for This Image</button>
    </div>
    <script>
    // IMPORTANT: If you open this via file:/// you might get CORS errors.
    // Serve it with a local server instead, e.g.:
    //   python3 -m http.server 8000
    // Then open http://localhost:8000/ in your browser.

    // Example static array of image paths (replace with your actual image URLs)
    // If you want to load from a server, use fetch() and assign to 'images'.
    let images = [
    "reference_images/0.jpg",
    "reference_images/1.jpg",
    "reference_images/2.jpg",
    "reference_images/3.jpg",
    "reference_images/4.jpg",
    "reference_images/5.jpg",
    "reference_images/6.jpg",
    "reference_images/7.jpg",
    "reference_images/8.jpg",
  ];

    // We keep a data structure that maps each image to its label and points.
    // We'll store just one label per image, but multiple points.
    // Example:
    // [
    //   {
    //     filename: 'img1.jpg',
    //     label: 'someLabel',
    //     points: [ { x: 100, y: 200 }, ... ]
    //   },
    //   { ... },
    // ]

    let annotationData = images.map(filename => ({
      filename: filename,
      label: '',
      points: []
    }));

    let currentIndex = 0;
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');

    // Show the current image on the canvas.
    function showImage(index) {
      const imageObj = new Image();
      imageObj.src = images[index];
      imageObj.onload = () => {
        // Clear the canvas.
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Draw the image to fill the canvas.
        ctx.drawImage(imageObj, 0, 0, canvas.width, canvas.height);
        // Draw any previously recorded points.
        annotationData[index].points.forEach(pt => {
          drawPoint(pt.x, pt.y);
        });
      };
    }

    // Draw a small circle for each point.
    function drawPoint(x, y) {
      ctx.fillStyle = 'red';
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, 2 * Math.PI);
      ctx.fill();
    }

    // On canvas click, record a new point.
    canvas.addEventListener('click', event => {
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      annotationData[currentIndex].points.push({ x, y });
      drawPoint(x, y);
    });

    // One label per image. Prompt user for a label.
    function setLabelForCurrentImage() {
      const currentImageData = annotationData[currentIndex];
      const newLabel = prompt('Enter a label for this image:', currentImageData.label);
      if (newLabel !== null) {
        currentImageData.label = newLabel;
      }
    }

    // Navigation.
    function prevImage() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      showImage(currentIndex);
    }

    function nextImage() {
      currentIndex = (currentIndex + 1) % images.length;
      showImage(currentIndex);
    }

    // Export to JSON.
    function exportJSON() {
      const dataStr = JSON.stringify(annotationData, null, 2);
      console.log('Exported JSON:', dataStr);

      // Optionally, download as a file.
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = 'annotations.json';
      link.click();
    }

    // Initialize the first image.
    showImage(currentIndex);
    </script>
  </body>
</html>
